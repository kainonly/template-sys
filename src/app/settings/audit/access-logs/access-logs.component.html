<nz-page-header [nzGhost]="false">
  <nz-page-header-title>
    <span i18n>访问日志</span>
  </nz-page-header-title>
  <nz-page-header-tags>
    <nz-range-picker
      nzBorderless
      nzFormat="yyyy-MM-dd HH:mm"
      [nzShowTime]="{ nzFormat: 'HH:mm' }"
      [nzDisabledDate]="disabledDate"
      [(ngModel)]="date"
      (ngModelChange)="getData(true)"
    ></nz-range-picker>
  </nz-page-header-tags>
  <nz-page-header-extra>
    <nz-space>
      <ng-container *nzSpaceItem>
        <button nzShape="circle" nz-button i18n disabled>
          <span nz-icon nzType="export"></span>
        </button>
      </ng-container>
    </nz-space>
  </nz-page-header-extra>
  <nz-page-header-content>
    <nz-row nzJustify="space-between" nzAlign="bottom">
      <nz-col>
        <nz-space>
          <ng-container *nzSpaceItem>
            <nz-input-group style="width: 180px" nzSuffixIcon="search">
              <input
                (keyup.enter)="getData(true)"
                [(ngModel)]="searchText"
                type="text"
                nz-input
                placeholder="搜索"
                i18n-placeholder
              />
            </nz-input-group>
          </ng-container>
          <ng-container *nzSpaceItem>
            <nz-button-group>
              <button nz-button nzType="text" nz-tooltip="刷新" i18n-nz-tooltip (click)="getData(true)">
                <span nz-icon nzType="reload"></span>
              </button>
              <button nz-button nzType="text" nz-tooltip="重置" i18n-nz-tooltip (click)="clear()">
                <span nz-icon nzType="clear"></span>
              </button>
            </nz-button-group>
          </ng-container>
        </nz-space>
      </nz-col>
      <nz-col></nz-col>
      <nz-col>
        <span>共计 {{ ds.total }} 条记录</span>
      </nz-col>
    </nz-row>
  </nz-page-header-content>
</nz-page-header>

<div class="content">
  <nz-card>
    <nz-table
      #basicTable
      [nzFrontPagination]="false"
      [nzShowSizeChanger]="true"
      [nzHideOnSinglePage]="true"
      [nzLoading]="ds.loading"
      [nzData]="ds.values"
      [nzTotal]="ds.total"
      [(nzPageSize)]="ds.pagesize"
      [(nzPageIndex)]="ds.page"
      (nzPageIndexChange)="getData(false)"
      (nzPageSizeChange)="getData(true)"
    >
      <thead>
        <tr>
          <th
            nzWidth="60px"
            nzLeft
            nzAlign="center"
            [nzChecked]="ds.checked"
            [nzIndeterminate]="ds.indeterminate"
            (nzCheckedChange)="ds.setNChecked($event)"
          >
          </th>
          <th nzWidth="240px"><b i18n>时间戳</b></th>
          <th><b i18n>操作人</b></th>
          <th><b i18n>资源</b></th>
          <th nzWidth="60px" nzRight nzAlign="center">
            <button nz-button nzType="text" nzBlock disabled>
              <span nz-icon nzType="setting"></span>
            </button>
          </th>
        </tr>
      </thead>
      <tbody>
        <ng-container *ngFor="let data of basicTable.data">
          <tr>
            <td
              nzLeft
              nzAlign="center"
              [nzDisabled]="data['disabled']"
              [nzChecked]="ds.checkedIds.has(data['_id'])"
              (nzCheckedChange)="ds.setChecked(data['_id'], $event)"
            >
            </td>
            <td [nzExpand]="expands.has(data._id)" (nzExpandChange)="expandsChange(data._id, $event)">
              {{ data['timestamp'] | date : 'yyyy-MM-dd HH:mm:ss' }}
            </td>
            <td>
              <a *ngIf="userKV[data.metadata.user_id] as user; else isSystem" (click)="openUserDetail(user)">
                <ng-container *ngIf="user.name; else showEmail">
                  {{ user.name }}
                </ng-container>
                <ng-template #showEmail> {{ user.email }} </ng-template>
              </a>
              <ng-template #isSystem>
                <span i18n>系统</span>
              </ng-template>
            </td>
            <td>
              <nz-space>
                <code *nzSpaceItem>{{ data.status }}</code>
                <code *nzSpaceItem>{{ data.metadata.method }}</code>
                <code *nzSpaceItem>{{ data.metadata.path }}</code>
              </nz-space>
            </td>
            <td nzRight nzAlign="center">
              <button nz-button nzType="text" nz-dropdown [nzDropdownMenu]="menu">
                <span nz-icon nzType="ellipsis"></span>
              </button>
              <nz-dropdown-menu #menu="nzDropdownMenu">
                <ul nz-menu>
                  <li nz-menu-item i18n>标记</li>
                </ul>
              </nz-dropdown-menu>
            </td>
          </tr>
          <tr [nzExpand]="expands.has(data._id)">
            <div style="padding: 3.5px 4px">
              <code>{{ data.user_agent }}</code>
            </div>
          </tr>
        </ng-container>
      </tbody>
    </nz-table>
  </nz-card>
</div>

<nz-drawer
  [nzClosable]="false"
  [nzVisible]="userDetailVisible"
  [nzWidth]="640"
  nzPlacement="right"
  nzTitle="用户详情"
  i18n-nzTitle
  (nzOnClose)="closeUserDetail()"
>
  <ng-container *nzDrawerContent>
    <nz-descriptions *ngIf="userDetail as u" nzBordered [nzColumn]="2">
      <nz-descriptions-item nzTitle="ID" [nzSpan]="2">{{ u._id }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="电子邮件">{{ u.email }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="称呼">
        <ng-container *ngIf="u.name; else noName">
          {{ u.name }}
        </ng-container>
        <ng-template #noName> None </ng-template>
      </nz-descriptions-item>
      <nz-descriptions-item nzTitle="头像" [nzSpan]="2">{{ u.avatar }}</nz-descriptions-item>
      <nz-descriptions-item nzTitle="状态" [nzSpan]="2">
        <ng-container *ngIf="u.status; else isFalse">
          <nz-badge nzStatus="processing"></nz-badge> <span i18n>开启</span>
        </ng-container>
        <ng-template #isFalse> <nz-badge nzStatus="default"></nz-badge> <span i18n>关闭</span> </ng-template>
      </nz-descriptions-item>
      <nz-descriptions-item nzTitle="累计会话" [nzSpan]="2">
        <span i18n>
          已登录 <b> {{ u.sessions }} </b> 次
        </span>
      </nz-descriptions-item>
      <nz-descriptions-item *ngIf="u.history as history" nzTitle="最近登录时间" i18n-nzTitle [nzSpan]="2">
        {{ history.timestamp | date : 'yyyy/MM/dd HH:mm:ss' }}
      </nz-descriptions-item>
      <nz-descriptions-item *ngIf="u.history as history" nzTitle="IP" [nzSpan]="2">
        {{ history.client_ip }}
      </nz-descriptions-item>
      <nz-descriptions-item nzTitle="地区 ISP" i18n-nzTitle [nzSpan]="2">
        <nz-space *ngIf="u.history as history" [nzSplit]="spaceSplit">
          <span *nzSpaceItem i18n>{{ !history.country ? '未知' : history.country }}</span>
          <span *nzSpaceItem i18n>{{ !history.province ? '未知' : history.province }}</span>
          <span *nzSpaceItem i18n>{{ !history.city ? '未知' : history.city }}</span>
          <span *nzSpaceItem i18n>{{ !history.isp ? '未知' : history.isp }}</span>
        </nz-space>
      </nz-descriptions-item>
      <nz-descriptions-item nzTitle="创建时间" i18n-nzTitle [nzSpan]="2">
        {{ u.create_time | date : 'yyyy/MM/dd HH:mm:ss' }}
      </nz-descriptions-item>
      <nz-descriptions-item nzTitle="更新时间" i18n-nzTitle [nzSpan]="2">
        {{ u.update_time | date : 'yyyy/MM/dd HH:mm:ss' }}
      </nz-descriptions-item>
    </nz-descriptions>
  </ng-container>
</nz-drawer>

<ng-template #spaceSplit>
  <nz-divider nzType="vertical"></nz-divider>
</ng-template>
